# Malware Detection Lab

## Objective

The Malware Detection Lab project aimed to establish a controlled environment for simulating and detecting cyber attacks. The primary focus was to ingest and analyze logs within a Security Information and Event Management (SIEM) system, generating test telemetry to mimic real-world attack scenarios. This allowed us to try and recognize logs indicitave of compromise or malicious processes and create detection and response rules to prevent further issues. This project was based on Eric Capuano's [guide](https://blog.ecapuano.com/p/so-you-want-to-be-a-soc-analyst-intro?sd=pf)

### Skills Learned

- Advanced understanding of SIEM concepts and practical application.
- Proficiency in analyzing and interpreting logs.
- Ability to generate and recognize attack signatures and patterns.
- Enhanced knowledge of security vulnerabilities.
- Development of critical thinking and problem-solving skills in cybersecurity.

### Tools Used

- LimaCharlie a Endpoint Detection and Response(EDR) system for log ingestion and analysis.
- Endpoint analysis tools (such as Sysmon) for capturing and examining endpoint processes and filtering this into LimaCharlie.
- Sliver an adversary emulation attack system to send malware and generate malcious traffic on the endpoint.

## Steps

1. The first step was to set up the virtual machines(VM) to emulate the attack and end-point systems in [VMWare](https://www.vmware.com/products/workstation-pro.html). Unfortantely this project does require the paid version of VMWare Workstation, but I used a 30 day free trial which was more then enough time to complete the project. 

This project utilized the developer VM for Windows 11 as the end-point which can be found [here](https://developer.microsoft.com/en-us/windows/downloads/virtual-machines/)

The attack system is an Ubuntu Server VM which can be found here [here](https://ubuntu.com/download/server)

It is important to kill Windows Defender on the end-point system because I didnt want it to do its job. 

2. The second step after the VMs are set up is to load some softwares that will allow us to monitor the end-point and create detecion and response rules.  

I first set up Sysmon to get very specific telemetry to feed into LimaCharlie.  

After Sysmon was set up i then moved to set up LimaCharlie.  LimaCharlie is a cool EDR tool that that will allow me to see processes on the endpoint and analyze it for malicious processes. 

I connected LimaCharlie to the end point system and set up the Sysmon logs to feed into LimaCharlie as well to get the best telemetry we can.

3. The endpoint is now set up so i moved onto the third step which was to set up the Ubuntu Vm or the attack system by downloading Sliver.

I used Sliver which is a pentesting framework used for emulating redteam work.  This allows us to send malware and infect a system with minimal risk of bricking the endpoint. 

4. The Virtual Machines are now set up and it is time to simulate a compromise.

I ssh into the Ubuntu Server via my main system and launched Sliver.  I generated a payload via Sliver and created a temporary web server to allow the Windows VM a method to download the payload. I then moved to my Windows VM and downloaded the payload via the server.

Back in Sliver i verify that i have control of the host by running some basic commands and determine my level of privilege in the system with "getprivs". 

This is enough to allow us to start noticing something in LimaCharlie. 

5. I logged into LimaCharlie in a browser and navigated to the sensor for our end-point and dove into the processes currently running on it.

It is important to recognize that the malcious process titled SWISS_YOU.exe in my lab is not signed and that stands out to me as commonly safe processes are signed while this isnt a 100% given it is enough cause to do more investigation. 

I can also see that this process is active on the network which is also cause for concern if i have an unsigned and unknown process communicating with outside source. 

I can also go and investigate this process further and discover that it was downloaded and i can grab the hash to run through VirusTotal. 

VirusTotal doesnt recognize it but that doesnt mean i assume its safe, just requires more investigation. 

6.  Now that i have a potentially malcious process identified i can drill down to more specific analysis of it.

I can search this process in Timeline section which displays events that have previously occured and are actively occuring on the end-point. 

I can see when it was downloaded and what events its responsible for.  The "getprivs" event will be shown as a sensitve process and is not something an end-user what run commonly.  This is another cause for concern and can help us in rule creation to block use of these sensitive processes. 

7.  I am now familiar with LimaCharlie and how to locate some potentially malicious processes and investigate them further.

I am going to go back to my attack system and try to gain some credential data and generate more telemetry for analysis.

I dump the lsass.exe from memory into a file on my attack system. This would provide credentials for the system and potentially admin credentials as well. 

This would obviously be a bad thing to see show up in LimaCharlie and be a definite Indictor of Compromise(IoC).  

I log into LimaCharlie and go to Timeline to analyze events.  I filter for Sensitive processes which we know should not commonly be occuring or only within certain contexts.

With this knowledge i create a detection and response rule to inform us when there is a sensitive process in regards to lsass.exe

8. I want to test the detection rule and try and create another more robust role.

I return to my instance of Sliver and go back over my previous steps and confirm that my detction rule is indeed working and notfiyng me that the lsass.exe memory has been exfiltrated. 

A more robust response to a detection would be to not only inform us it occured but to kill it and block it from occuring.

I am going to create a rule that would block a command to delete Volume Shadow Copies which can sometime be targeted in Ransomware attacks. 

The detection and repsonse rule will not only block that process but kill the connection from the threat actor.

I will go back to my attack system and attempt to execute this command and realize that i have been kicked off the system.


## Conclusion

This project was a great way to get some basic hands on experience with analyzing event logs and crafting some rudemtary detection and response rules.  I really enjoyed this project and plan on building on the fundementals of this lab to do more advanced projects. 




## Edits Needed

Add Screenshots


